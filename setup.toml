# Layer 0: Shell setup (runs before all other layers)
[layer0]
name = "Shell Setup"
oh_my_zsh_url = "https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh"
powerlevel10k_repo = "https://github.com/romkatv/powerlevel10k.git"

# Shell symlinks (applied early to ensure PATH is correct after Homebrew install)
[[layer0.symlinks]]
name = "zsh"
source = "{script_dir}/.zshrc"
target = "{home}/.zshrc"
force = true

[[layer0.symlinks]]
name = "powerlevel10k"
source = "{script_dir}/.p10k.zsh"
target = "{home}/.p10k.zsh"
force = true

[[layer0.symlinks]]
name = "profile"
source = "{home}/.zshrc"
target = "{home}/.profile"
force = true

# Layer 1: Sudo configuration
[layer1]
name = "Sudo Configuration"

# Touch ID for standard sudo (recommended)
[layer1.touchid]
enabled = true
pam_file = "/etc/pam.d/sudo"
pam_line = "auth       sufficient     pam_tid.so"
insert_after = "auth       include        sudo_local"

# Custom sudo binary (alternative)
[layer1.custom_sudo]
source_file = "{script_dir}/sudo/sudo.cpp"
target_binary = "{home}/bin/sudo"
compile_command = "clang++ --std=c++14 -O3 {source} -o {target}"
install_commands = [
    "/usr/bin/sudo chown root: {target}",
    "/usr/bin/sudo chmod +s {target}"
]

# Layer 2: Base system packages
[layer2]
name = "Base System Packages"

# Homebrew taps to add before installing packages
brew_taps = [
    "d12frosted/emacs-plus",
]

# All brew packages (formulae and casks) to install
brew_packages = [
    "arc",
    "base64",
    "basedpyright",
    "bentobox",
    "blackhole-64ch",
    "clang-format",
    "claude",
    "cliclick",
    "clipgrab",
    "cmake",
    "codex",
    "contexts",
    "coreutils",
    "cryptomator",
    "dcfldd",
    "dos2unix",
    "drawio",
    "editorconfig",
    "enchant",
    "ffmpeg",
    "font-iosevka-comfy",
    "font-iosevka-term-nerd-font",
    "font-jetbrains-mono-nerd-font",
    "font-juliamono",
    "font-roboto",
    "font-symbols-only-nerd-font",
    "gh",
    "gimp",
    "git",
    "glslang",
    "google-java-format",
    "gopls",
    "gotests",
    "grpcurl",
    "hammerspoon",
    "htop",
    "hunspell",
    "iftop",
    "img2pdf",
    "iperf3",
    "isort",
    "isync",
    "jansson",
    "jdtls",
    "jenv",
    "jq",
    "keepassxc",
    "kubernetes-cli",
    "leiningen",
    "libpaho-mqtt",
    "llvm",
    "lua-language-server",
    "mailspring",
    "make",
    "markdown",
    "menumeters",
    "meson",
    "mosquitto",
    "msgpack-tools",
    "msmtp",
    "mu",
    "nasm",
    "nmap",
    "numpy",
    "nvm",
    "offlineimap",
    "ollama",
    "owncloud",
    "packages",
    "pandoc",
    "pdftk-java",
    "pipenv",
    "pipx",
    "poppler",
    "pytest",
    "python-packaging",
    "raycast",
    "reaper",
    "rectangle",
    "rsync",
    "ruff",
    "shellcheck",
    "signal",
    "slack",
    "spotify",
    "texinfo",
    "tor",
    "tor-browser",
    "tree",
    "typescript-language-server",
    "uv",
    "virtualenv",
    "vlc",
    "wezterm",
    "wget",
    "whatsapp",
    "wireshark",
    "wireshark-app",
]

# NPM global packages
npm_packages = [
    "@anthropic-ai/claude-code",
    "@tailwindcss/language-server",
    "@vtsls/language-server",
    "bash-language-server",
    "typescript-language-server",
    "vscode-langservers-extracted",
    "yaml-language-server",
    "yarn",
]

# Python packages
pip_packages = [
    "typing_extensions",
]

# Post-install commands to run after packages are installed
post_install_commands = [
]

# Layer 3: Emacs installation
[layer3]
name = "Emacs Installation"
formula = "emacs-plus@30"
options = [
    "--with-imagemagick",
    "--with-mailutils",
    "--with-xwidgets",
]

# Post-install commands to run after Emacs is installed
post_install_commands = [
    "rm -rf /Applications/Emacs.app",
    "osascript -e 'tell application \"Finder\" to make alias file to posix file \"{brew_prefix}/Cellar/emacs-plus@30/30.2/Emacs.app\" at posix file \"/Applications\" with properties {{name:\"Emacs.app\"}}'",
]

# Spelling dictionaries to download
[[layer3.dictionaries]]
filename = "de_DE_frami.aff"
url = "https://github.com/LibreOffice/dictionaries/raw/refs/heads/master/de/de_DE_frami.aff"

[[layer3.dictionaries]]
filename = "de_DE_frami.dic"
url = "https://github.com/LibreOffice/dictionaries/raw/refs/heads/master/de/de_DE_frami.dic"

[[layer3.dictionaries]]
filename = "en_US.aff"
url = "https://github.com/LibreOffice/dictionaries/raw/refs/heads/master/en/en_US.aff"

[[layer3.dictionaries]]
filename = "en_US.dic"
url = "https://github.com/LibreOffice/dictionaries/raw/refs/heads/master/en/en_US.dic"

# Layer 4: Doom Emacs
[layer4]
name = "Emacs Setup"
repo = "https://github.com/doomemacs/doomemacs"
install_path = "{home}/.config/emacs"

# Commands to run after Doom installation/sync
post_install_commands = [
    "brew services start d12frosted/emacs-plus/emacs-plus@30",
]

# Emacs configuration symlinks (chosen during setup)
[layer4.emacs_symlinks.doom]
name = "doom"
source = "{script_dir}/.doom.d"
target = "{home}/.config/doom"

[layer4.emacs_symlinks.light]
name = "emacs"
source = "{script_dir}/.emacs"
target = "{home}/.emacs"

# Layer 5: Symlinks and Shell
[layer5]
name = "Symlinks"

# {script_dir} = directory containing setup.py
# {home} = user's home directory
# {brew_prefix} = homebrew prefix (/opt/homebrew or /usr/local)
[[layer5.symlinks]]
name = "tools"
source = "{script_dir}"
target = "{home}/bin/tools"

[[layer5.symlinks]]
name = "clang-format"
source = "{script_dir}/.clang-format"
target = "{home}/.clang-format"

[[layer5.symlinks]]
name = "editorconfig"
source = "{script_dir}/.editorconfig"
target = "{home}/.editorconfig"

[[layer5.symlinks]]
name = "hammerspoon"
source = "{script_dir}/.hammerspoon"
target = "{home}/.hammerspoon"

[[layer5.symlinks]]
name = "wezterm"
source = "{script_dir}/.wezterm.lua"
target = "{home}/.wezterm.lua"

[[layer5.symlinks]]
name = "wezterm-terminfo"
source = "{script_dir}/.terminfo"
target = "{home}/.terminfo"

[[layer5.symlinks]]
name = "claude-statusline"
source = "{script_dir}/claude-statusline.sh"
target = "{home}/.claude/statusline.sh"

[[layer5.symlinks]]
name = "claude-settings"
source = "{script_dir}/claude-settings.json"
target = "{home}/.claude/settings.json"

[[layer5.symlinks]]
name = "claude-emacs-hook"
source = "{home}/.config/emacs/.local/straight/repos/claude-code.el/bin/claude-code-hook-wrapper"
target = "{home}/bin/claude-code-hook-wrapper"

[[layer5.symlinks]]
name = "claude-supervisor"
source = "{script_dir}/claude-supervisor"
target = "{home}/bin/claude-supervisor"

[[layer5.symlinks]]
name = "claude-notify"
source = "{script_dir}/claude-notify"
target = "{home}/bin/claude-notify"
