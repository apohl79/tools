#!/bin/bash

# Claude Code notification script using alerter (with terminal-notifier fallback)
# Reads JSON from stdin and displays a configurable macOS notification.
# Clicking the notification switches Emacs to the workspace for the cwd.

# ============================================================
# Configuration
# ============================================================

# Timeout in seconds. 0 = persistent (stays until dismissed).
NOTIFICATION_TIMEOUT=0

# Sound to play. Empty string = no sound. "default" for system default.
NOTIFICATION_SOUND=""

# Icon source (macOS .icns file)
ICON_SOURCE="/Applications/Claude.app/Contents/Resources/electron.icns"

# Cached PNG icon location (alerter needs PNG, not .icns)
ICON_CACHE="$HOME/.cache/claude-notify/claude-icon.png"

# Command to run when notification is clicked (receives cwd as argument)
CLICK_COMMAND="$(dirname "$(readlink -f "$0")")/../emacs-switch-workspace"

# ============================================================
# Icon setup
# ============================================================

ensure_icon() {
  if [ ! -f "$ICON_CACHE" ] || [ "$ICON_SOURCE" -nt "$ICON_CACHE" ]; then
    [ -f "$ICON_SOURCE" ] || return 0
    mkdir -p "$(dirname "$ICON_CACHE")"
    sips -s format png "$ICON_SOURCE" --out "$ICON_CACHE" >/dev/null 2>&1 || rm -f "$ICON_CACHE"
  fi
}

# ============================================================
# Main
# ============================================================

json_input=$(cat)

message=$(jq -r '.message // .title // "Claude Code notification"' <<< "$json_input" 2>/dev/null)
full_cwd=$(jq -r '.cwd // empty' <<< "$json_input" 2>/dev/null)
cwd_short=$(basename "$full_cwd" 2>/dev/null)

ensure_icon

# Build alerter arguments
args=(
  --title "Claude Code"
  --message "$message"
  --close-label "Dismiss"
)

# Group by md5 hash of cwd (paths with slashes don't work as group IDs).
# The OS replaces the old notification automatically when a new one with the
# same group arrives â€” no need to kill or remove the old alerter process.
[ -n "$full_cwd" ] && args+=(--group "$(echo "$full_cwd" | md5 -q)")
[ -n "$cwd_short" ] && args+=(--subtitle ":: $cwd_short")
[ -n "$NOTIFICATION_SOUND" ] && args+=(--sound "$NOTIFICATION_SOUND")
[ "$NOTIFICATION_TIMEOUT" -gt 0 ] 2>/dev/null && args+=(--timeout "$NOTIFICATION_TIMEOUT")
[ -f "$ICON_CACHE" ] && args+=(--app-icon "$ICON_CACHE")

# Run alerter in background (it blocks until user interaction or timeout)
(
  result=$(alerter "${args[@]}" 2>/dev/null)
  if [ "$result" = "@CONTENTCLICKED" ] && [ -n "$full_cwd" ]; then
    "$CLICK_COMMAND" "$full_cwd"
  fi
) &
disown

exit 0
